#!/bin/ksh
# RB 2007/02/16
# $Id$
#
# Backup local filesystems to local or remote device.
#

PATH=/usr/sbin:/usr/xpg4/bin:/usr/bin:$PATH

BASE=$(cd $(dirname $0)/..; pwd)
LOG_FILE=$BASE/log/backup.log
TOC_FILE=$BASE/log/toc
EXCLUDE_FILE=$BASE/etc/exclude
NOSNAP_FILE=$BASE/etc/nosnap
MAIL_USERS=
SCRIPT_BASE=$BASE/scripts
HOSTNAME=$(hostname)

function usage
{
	echo "USAGE: $0 [options]"
	echo "       -d [[user@]host:]device  # backup device"
	echo "       -n                       # run without tape"
	echo "       -e                       # don't eject tape"
	echo "       -v                       # direct output to stdout"
}

while getopts cd:emnr:svh c
do
	case $c in
	c)	ACTION=log_view
		;;
	d)	DUMP_DEVICE=$OPTARG
		;;
	e)	NO_EJECT=1
		;;
	m)	MAIL_LOG=1
		;;
	n)	NO_TAPE=1
		DUMP_DEVICE=/dev/null
		;;
	r)	RSH=$OPTARG
		;;
	s)	RSH="ssh -o BatchMode=yes"
		;;
	v)	OUTPUT=/dev/stdout
		;;
	h)	usage 0
		;;
	*)	usage 1
		;;
	esac
done
shift $((OPTIND - 1))

# Set defaults
: ${ACTION:=backup_all}
: ${DUMP_DEVICE:=/dev/rmt/0cbn}
: ${RSH:=rsh}
: ${OUTPUT:=/dev/null}
: ${NO_TAPE:=0}
: ${NO_REWIND:=0}
: ${NO_EJECT:=0}
: ${FSTYPES:=ufs zfs}
: ${PAX_FORMAT:=xustar}
: ${SNAPSHOT_ZFS:=1}
: ${SNAPSHOT_UFS:=1}
: ${BACKING_STORE:=/var/tmp}
: ${MAIL_LOG:=0}
: ${MAIL_USERS:=p0073773@brookes.ac.uk}

# Set remote command defaults
GREP=/usr/xpg4/bin/grep
AWK=/usr/xpg4/bin/awk
MT=/usr/bin/mt
DD=/usr/bin/dd
PAX=/usr/bin/pax
UFSDUMP=/usr/sbin/ufsdump

# Calculate additional settings
REMOTE=$(echo $DUMP_DEVICE | $GREP :)
if [[ -n "$REMOTE" ]]; then
	echo $DUMP_DEVICE | sed 's/:/ /' | read DUMP_HOST DUMP_DEVICE
fi

# Print a pretty datestamp
function datestamp
{
	date +'%Y-%m-%d %H:%M:%S'
}

# Check tape status
function tape_status
{
	if (( NO_TAPE > 0 )); then
		echo "--> running without tape"
		TAPE_STATUS=$NO_TAPE
	else
		echo "--> checking tape status"
		${REMOTE:+$RSH $DUMP_HOST} $MT -f $DUMP_DEVICE status
		TAPE_STATUS=$?
	fi
}

# Rewind tape
function tape_rewind
{
	if (( NO_TAPE > 0 || TAPE_STATUS > 0 || NO_REWIND > 0 )); then
		echo "--> skipped tape rewind"
	else
		echo "--> rewinding tape"
		${REMOTE:+$RSH $DUMP_HOST} $MT -f $DUMP_DEVICE rewind
	fi
}

# Eject tape
function tape_eject
{
	if (( NO_TAPE > 0 || TAPE_STATUS > 0 || NO_EJECT > 0 )); then
		echo "--> skipped tape eject"
	else
		echo "--> ejecting tape"
		${REMOTE:+$RSH $DUMP_HOST} $MT -f $DUMP_DEVICE offline
	fi
	return $?
}

# Write data to tape
function tape_write
{
	if (( TAPE_STATUS > 0 )); then
		echo "--> NO TAPE: piping to /dev/null"
		$DD of=/dev/null
	else
		${REMOTE:+$RSH $DUMP_HOST} $DD of=$DUMP_DEVICE bs=1024
	fi
}

# Generate a ToC for the pending backup
function toc_create
{
	echo "--> generating table of contents:"
	if [[ -f $EXCLUDE_FILE ]]; then
		EXCLUDE=$($AWK 'BEGIN {printf "^(";} $0 !~ /#/ && $0 != "" {printf "%s%s", (i++>0)?"|":"", $0;} END {printf ")$";}' $EXCLUDE_FILE)
	else
		echo "--> exclude file not found"
		EXCLUDE='^$'
	fi
	for t in $FSTYPES; do
		$AWK -v fstype=$t -v exclude=$EXCLUDE \
			'$3 == fstype && $2 !~ exclude {print $3, $1, $2}' \
		< /etc/mnttab
	done | pr -tn > $TOC_FILE
	STATUS=$?
	cat $TOC_FILE
	return $STATUS
}

# Write backup ToC to dump device
function toc_write
{
	echo "--> writing table of contents"
	echo Backup of $HOSTNAME: $(datestamp) | cat - $TOC_FILE | tape_write
	return $?
}

# Create a snapshot of a zfs filesystem
# $1 = FILESYSTEM
# $2 = MOUNTPOINT
# Result: snapshot mountpoint or nothing if snapshot fails.
function snap_create_zfs
{
	HAS_SNAP=0
	NOSNAP=$(echo $2 | $GREP -cF -f <(cat $NOSNAP_FILE | $GREP -v '#' | $GREP -v '^$'))
	if (( SNAPSHOT_ZFS > 0 && $NOSNAP == 0 )); then
		echo "--> creating zfs snapshot of $2" 1>&2
		SNAPSHOT=$2/.zfs/snapshot/backup
		zfs snapshot $1@backup
		if [[ $? -eq 0 && -d $SNAPSHOT ]]; then
			echo $SNAPSHOT
			HAS_SNAP=1
		else
			echo "--> ERROR: snapshot creation failed: $2" 1>&2
			echo "--> proceeding with non-snap backup" 1>&2
			echo $2
		fi
	else
		echo "--> skipped creation of zfs snapshot: $2" 1>&2
		echo $2
	fi
	return $HAS_SNAP
}

# Create a snapshot of a ufs filesystem
# $1 = DEVICE
# $2 = MOUNTPOINT
# Result: snapshot device or original device if snapshot fails.
# Side-effects: sets HAS_SNAP=1 if snapshot created, 0 otherwise.
function snap_create_ufs
{
	HAS_SNAP=0
	NOSNAP=$(echo $2 | $GREP -cF -f <(cat $NOSNAP_FILE | $GREP -v '#' | $GREP -v '^$'))
	if (( SNAPSHOT_UFS > 0 && NOSNAP == 0 )); then
		echo "--> creating ufs snapshot: $2" 1>&2
		fssnap -F ufs -o maxsize=512m,bs=$BACKING_STORE,unlink $2
		if (( $? > 0 )); then
			echo "--> ERROR: snapshot creation failed: $2" 1>&2
			echo "--> proceeding with non-snap backup" 1>&2
			echo $1
		else
			HAS_SNAP=1
		fi
	else
		echo "--> skipped creation of ufs snapshot: $2" 1>&2
		echo $1
	fi
	return $HAS_SNAP
}

# Destroy the snapshot of a zfs filesystem
# $1 = FILESYSTEM
# $2 = MOUNTPOINT
# Result: nothing
function snap_delete_zfs
{
	echo "--> deleting zfs snapshot: $2"
	zfs destroy -f $1@backup
	if (( $? > 0 )); then
		echo "--> ERROR: snapshot deletion failed: $2"
	fi
}

# Destroy the snapshot of a ufs filesystem
# $1 = DEVICE
# $2 = MOUNTPOINT
# Result: nothing
function snap_delete_ufs
{
	echo "--> deleting ufs snapshot: $2"
	fssnap -d $2
	if (( $? > 0 )); then
		echo "--> ERROR: snapshot deletion failed: $2"
	fi
}

# Dump a zfs filesystem via pax
# $1 = FILESYSTEM
# $2 = MOUNTPOINT
function dump_zfs
{
	SNAPSHOT=$(snap_create_ufs $1 $2)
	if (( $? > 0 )); then
		trap "snap_delete_ufs $1 $2" ERR INT EXIT
	fi
	cd $SNAPSHOT
	if (( $? > 0 )); then
		echo "==> ERROR: $SNAPSHOT not found, dump of $2 failed: $(datestamp)"
		return 1
	fi
	echo "==> commencing dump of $2 via pax: $(datestamp)"
	$PAX -w -pe -x $PAX_FORMAT -X . | tape_write
	STATUS=$?
	if (( STATUS > 0 )); then
		echo "--> ERROR: dump of $2 failed: $(datestamp)"
	else
		echo "--> completed dump of $2: $(datestamp)"
	fi
	cd -
	return $STATUS
}

# Dump a ufs filesystem via ufsdump
# $1 = DEVICE
# $2 = MOUNTPOINT
function dump_ufs
{
	SNAPSHOT=$(snap_create_ufs $1 $2)
	if (( $? > 0 )); then
		trap "snap_delete_ufs $1 $2" ERR INT EXIT
	fi
	echo "==> commencing dump of $2 via ufsdump: $(datestamp)"
	$UFSDUMP 0uf - $SNAPSHOT | tape_write
	STATUS=$?
	if (( STATUS > 0 )); then
		echo "--> ERROR: dump of $2 failed: $(datestamp)"
	else
		echo "--> completed dump of $2: $(datestamp)"
	fi
	return $STATUS
}

# Mail interested parties
function mail_users
{
	mailx -s "Message from $HOSTNAME: backup failed" $MAIL_USERS
}

# Backup all local filesystems
function backup_all
{
	echo "===> Backup commenced: $(datestamp)"
	tape_status
	tape_rewind
	toc_create
	toc_write
	while read NUM FSTYPE DEVICE MOUNTPOINT; do
		dump_$FSTYPE $DEVICE $MOUNTPOINT
		(( STATUS > 0 )) && MAIL_LOG=1
	done < $TOC_FILE
	tape_eject
	echo "===> Backup completed: $(datestamp)"
}

case $# in
0)	backup_all | tee -a $LOG_FILE >$OUTPUT
	;;
*)	echo "NOT IMPLEMENTED"
	usage 1
	;;
esac

if (( MAIL_LOG > 0 )); then
	mail_users < $LOG_FILE
fi

